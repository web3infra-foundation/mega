import Head from 'next/head'
import Image from 'next/image'
import { AppLayout } from '@/components/Layout/AppLayout'
import AuthAppProviders from '@/components/Providers/AuthAppProviders'
import { useState, useEffect } from 'react'    
// import { ExclamationTriangleIcon, ShieldCheckIcon, ClockIcon, UserIcon } from '@heroicons/react/24/outline'
import { useRouter } from 'next/router'

// CVE 详情接口类型定义
interface CVEDetail {
  id: string
  subtitle: string
  reported: string
  issued: string
  package: string
  ttype: string
  keywords: string
  aliases: string
  reference: string
  patched: string
  unaffected: string
  description: string
  url: string
}

export default function CVEInfoPage() {
  const router = useRouter()
  const { cveId } = router.query
  
  // 状态管理
  const [cveData, setCveData] = useState<CVEDetail | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  // 从 API 获取 CVE 详情数据
  useEffect(() => {
    const fetchCVEDetails = async () => {
      if (!cveId) return
      
      try {
        setLoading(true)
        setError(null)
        
        const apiBaseUrl = process.env.NEXT_PUBLIC_CRATES_PRO_URL
        const response = await fetch(`${apiBaseUrl}/api/cve/details/${cveId}`)
        
        if (!response.ok) {
          throw new Error('Failed to fetch CVE details')
        }
        
        const data: CVEDetail[] = await response.json()
        
        if (data && data.length > 0) {
          setCveData(data[0]) // 取第一个结果
        } else {
          throw new Error('No CVE data found')
        }
      } catch (err) {
        setError('Failed to load CVE details')
        
        // 如果 API 失败，使用默认数据
        setCveData({
          id: cveId as string,
          subtitle: 'CVE 详情加载失败',
          reported: 'Unknown',
          issued: 'Unknown',
          package: 'Unknown',
          ttype: 'Unknown',
          keywords: '',
          aliases: '',
          reference: '',
          patched: 'Unknown',
          unaffected: '',
          description: '无法加载 CVE 详情信息',
          url: ''
        })
      } finally {
        setLoading(false)
      }
    }

    fetchCVEDetails()
  }, [cveId])

  // 生成标签信息
  const getCveTag = (cve: CVEDetail | null) => {
    if (!cve) return { text: '未知', color: 'gray' }
    
    // 根据 ttype 生成标签
    if (cve.ttype.includes('Unmaintained')) {
      return { text: '项目已停止维护', color: 'red' }
    } else if (cve.ttype.includes('INFO')) {
      return { text: '信息类', color: 'blue' }
    } else if (cve.ttype.includes('WARN')) {
      return { text: '警告', color: 'yellow' }
    } else if (cve.ttype.includes('CRITICAL')) {
      return { text: '严重', color: 'red' }
    } else if (cve.ttype.includes('HIGH')) {
      return { text: '高危', color: 'red' }
    } else if (cve.ttype.includes('MEDIUM')) {
      return { text: '中危', color: 'yellow' }
    } else if (cve.ttype.includes('LOW')) {
      return { text: '低危', color: 'green' }
    }
    
    return { text: '安全漏洞', color: 'red' }
  }

  // 生成参考资料列表
  const getReferences = (cve: CVEDetail | null) => {
    if (!cve) return []
    
    const references = []
    
    if (cve.reference) {
      references.push({ title: 'Reference', url: cve.reference })
    }
    
    if (cve.url) {
      references.push({ title: 'RustSec Advisory', url: cve.url })
    }
    
    return references
  }

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <div className="text-gray-500">加载中...</div>
      </div>
    )
  }

  if (error && !cveData) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <div className="text-red-500">错误: {error}</div>
      </div>
    )
  }

  if (!cveData) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <div className="text-gray-500">未找到 CVE 信息</div>
      </div>
    )
  }

  const cveTag = getCveTag(cveData)
  const references = getReferences(cveData)

//   const tabs = [
//     { id: 'overview', name: '概览', icon: ExclamationTriangleIcon },
//     { id: 'details', name: '详细信息', icon: ShieldCheckIcon },
//     { id: 'timeline', name: '时间线', icon: ClockIcon },
//     { id: 'references', name: '参考资料', icon: UserIcon }
//   ]

  return (
    <>
      <Head>
        <title>{cveData.id} - CVE Information</title>
      </Head>
      <div className="h-screen overflow-auto">
        {/* 顶部 CVE ID 和标签区域 */}
        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <h1 className="text-3xl font-bold text-gray-900">{cveData.id}</h1>
              <span 
                style={{
                  display: 'inline-flex',
                  padding: '2px 6px',
                  justifyContent: 'center',
                  alignItems: 'center',
                  gap: '6px',
                  borderRadius: '3px',
                  background: '#0047f112',
                  color: '#002bb7c4',
                  fontFamily: 'HarmonyOS Sans SC',
                  fontSize: '12px',
                  fontStyle: 'normal',
                  fontWeight: 400,
                  lineHeight: '16px',
                  letterSpacing: '0.04px',
                }}
              >
                {cveTag.text}
              </span>
            </div>
            <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <Image 
                src="/rust/rust-ecosystem/ecosystem-cve/cve-info/Frame.png" 
                alt="Frame" 
                width={4}
                height={4}
                className="mr-2 w-4 h-4"
              />
              View Json
            </button>
          </div>
          
          {/* 分割线 */}
          <div className="mt-6 -mx-52 border-b border-gray-200"></div>
        </div>

                 {/* 主要内容区域 */}
         <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
          <h2 
            className="text-gray-900 mb-6"
            style={{
              color: '#1c2024',
              fontFamily: 'HarmonyOS Sans SC',
              fontSize: '26px',
              fontStyle: 'normal',
              fontWeight: 500,
              lineHeight: 'normal',
              letterSpacing: 'var(--Typography-Letter-spacing-3, 0)',
            }}
          >
            Required CVE Record Information
          </h2>
          
          {/* 信息卡片 */}
          <div className="space-y-6">
            {/* CNA 卡片 */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                             <h3 
                 className="mb-4"
                 style={{
                   alignSelf: 'stretch',
                   color: '#3a5bc7',
                   fontFamily: 'HarmonyOS Sans SC',
                   fontSize: '32px',
                   fontStyle: 'normal',
                   fontWeight: 500,
                   lineHeight: '40px',
                   letterSpacing: '-0.16px',
                 }}
               >
                 CNA : MITRE Corporation
               </h3>
               <div 
                 style={{
                   width: '100%',
                   height: '1px',
                   background: 'rgba(0, 0, 0, 0.08)',
                   marginBottom: '16px'
                 }}
               />
              <div className="space-y-4">
                <div>
                  <h4 
                    className="mb-2"
                    style={{
                      alignSelf: 'stretch',
                      color: '#1c2024',
                      fontFamily: 'HarmonyOS Sans SC',
                      fontSize: '24px',
                      fontStyle: 'normal',
                      fontWeight: 500,
                      lineHeight: 'normal',
                      letterSpacing: '-0.16px',
                    }}
                  >
                    Description
                  </h4>
                  <div className="mb-4">
                    <p className="text-sm text-gray-600 mb-1">
                      <span className="font-medium">Package:</span> {cveData.package}
                    </p>
                    <p className="text-sm text-gray-600">
                      <span className="font-medium">Type:</span> {cveData.ttype}
                    </p>
                  </div>
                  <p 
                    className="mb-6"
                    style={{
                      alignSelf: 'stretch',
                      color: '#80838d',
                      fontFamily: 'HarmonyOS Sans SC',
                      fontSize: '16px',
                      fontStyle: 'normal',
                      fontWeight: 400,
                      lineHeight: 'normal',
                      letterSpacing: '-0.16px',
                    }}
                  >
                    {cveData.description}
                  </p>
                </div>
                
                <div>
                  <div className="flex items-center mb-2">
                    <h4 
                      className="mb-0"
                      style={{
                        alignSelf: 'stretch',
                        color: '#1c2024',
                        fontFamily: 'HarmonyOS Sans SC',
                        fontSize: '24px',
                        fontStyle: 'normal',
                        fontWeight: 500,
                        lineHeight: 'normal',
                        letterSpacing: '-0.16px',
                      }}
                    >
                      Product Status
                    </h4>
                    <button 
                      className="ml-2 hover:bg-blue-200"
                      style={{
                        display: 'flex',
                        height: '24px',
                        padding: '0 8px',
                        justifyContent: 'center',
                        alignItems: 'center',
                        gap: '4px',
                        borderRadius: '3px',
                        border: '1px solid #0034dc73',
                        background: 'transparent',
                        color: '#002bb7c4',
                        fontFamily: 'SF Pro',
                        fontSize: '12px',
                        fontStyle: 'normal',
                        fontWeight: 500,
                        lineHeight: '16px',
                        letterSpacing: '0.04px',
                      }}
                    >
                      Learn More
                    </button>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="space-y-2">
                      <p className="text-sm text-gray-600">
                        <span className="font-medium">Patched:</span> {cveData.patched || 'No information available'}
                      </p>
                      {cveData.unaffected && (
                        <p className="text-sm text-gray-600">
                          <span className="font-medium">Unaffected:</span> {cveData.unaffected}
                        </p>
                      )}
                    </div>
                  </div>
                </div>
                
                <div>
                  <div className="flex items-center mb-2">
                    <h4 
                      style={{
                        alignSelf: 'stretch',
                        color: '#1c2024',
                        fontFamily: 'HarmonyOS Sans SC',
                        fontSize: '24px',
                        fontStyle: 'normal',
                        fontWeight: 500,
                        lineHeight: 'normal',
                        letterSpacing: '-0.16px',
                      }}
                    >
                      References
                    </h4>
                    <span 
                      className="ml-2"
                      style={{
                        display: 'flex',
                        padding: '2px 6px',
                        justifyContent: 'center',
                        alignItems: 'center',
                        gap: '6px',
                        borderRadius: '3px',
                        background: '#0047f112',
                        color: '#002bb7c4',
                        fontFamily: 'HarmonyOS Sans SC',
                        fontSize: '12px',
                        fontStyle: 'normal',
                        fontWeight: 400,
                        lineHeight: '16px',
                        letterSpacing: '0.04px',
                        marginTop: '4px',
                      }}
                    >
                      {references.length} Total
                    </span>
                  </div>
                  <div className="space-y-2">
                    {references.map((ref) => (
                      <a
                        key={ref.url}
                        href={ref.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          alignSelf: 'stretch',
                          color: '#002bb7c4',
                          fontFamily: 'HarmonyOS Sans SC',
                          fontSize: '16px',
                          fontStyle: 'normal',
                          fontWeight: 300,
                          lineHeight: 'normal',
                          letterSpacing: '-0.1px',
                        }}
                        className="block hover:text-blue-800"
                      >
                        {ref.url}
                      </a>
                    ))}
                  </div>
                </div>
                
                                 <div 
                   style={{
                     alignSelf: 'stretch',
                     color: '#1c2024',
                     fontFamily: 'HarmonyOS Sans SC',
                     fontSize: '16px',
                     fontStyle: 'normal',
                     fontWeight: 500,
                     lineHeight: 'normal',
                     letterSpacing: '-0.16px',
                   }}
                 >
                                       <p>
                      <span style={{ fontWeight: 500, color: '#1c2024', fontSize: '16px' }}>Reported: </span>
                      <span style={{ fontWeight: 400, color: '#80838d', fontSize: '16px' }}>{cveData.reported}</span>
                    </p>
                    <p>
                      <span style={{ fontWeight: 500, color: '#1c2024', fontSize: '16px' }}>Issued: </span>
                      <span style={{ fontWeight: 400, color: '#80838d', fontSize: '16px' }}>{cveData.issued}</span>
                    </p>
                 </div>
              </div>
            </div>

                         {/* CVE Program 卡片 */}
             <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
               <h3 
                 className="mb-4"
                 style={{
                   alignSelf: 'stretch',
                   color: '#3a5bc7',
                   fontFamily: 'HarmonyOS Sans SC',
                   fontSize: '32px',
                   fontStyle: 'normal',
                   fontWeight: 500,
                   lineHeight: '40px',
                   letterSpacing: '-0.16px',
                 }}
               >CVE : Program</h3>
               <div 
                 style={{
                   width: '100%',
                   height: '1px',
                   background: 'rgba(0, 0, 0, 0.08)',
                   marginBottom: '16px'
                 }}
               />
              
              <div className="space-y-4">
                <div>
                  <div className="flex items-center mb-2">
                    <h4 
                      style={{
                        alignSelf: 'stretch',
                        color: '#1c2024',
                        fontFamily: 'HarmonyOS Sans SC',
                        fontSize: '24px',
                        fontStyle: 'normal',
                        fontWeight: 500,
                        lineHeight: 'normal',
                        letterSpacing: '-0.16px',
                      }}
                    >
                      References
                    </h4>
                    <span 
                      className="ml-2"
                      style={{
                        display: 'flex',
                        padding: '2px 6px',
                        justifyContent: 'center',
                        alignItems: 'center',
                        gap: '6px',
                        borderRadius: '3px',
                        background: '#0047f112',
                        color: '#002bb7c4',
                        fontFamily: 'HarmonyOS Sans SC',
                        fontSize: '12px',
                        fontStyle: 'normal',
                        fontWeight: 400,
                        lineHeight: '16px',
                        letterSpacing: '0.04px',
                        marginTop: '4px',
                      }}
                    >
                      {references.length} Total
                    </span>
                  </div>
                  <div className="space-y-2">
                    {references.map((ref) => (
                      <a
                        key={ref.url}
                        href={ref.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          alignSelf: 'stretch',
                          color: '#002bb7c4',
                          fontFamily: 'HarmonyOS Sans SC',
                          fontSize: '16px',
                          fontStyle: 'normal',
                          fontWeight: 300,
                          lineHeight: 'normal',
                          letterSpacing: '-0.1px',
                        }}
                        className="block hover:text-blue-800"
                      >
                        {ref.url}
                      </a>
                    ))}
                  </div>
                </div>
                
                                 <div 
                   style={{
                     alignSelf: 'stretch',
                     color: '#1c2024',
                     fontFamily: 'HarmonyOS Sans SC',
                     fontSize: '16px',
                     fontStyle: 'normal',
                     fontWeight: 500,
                     lineHeight: 'normal',
                     letterSpacing: '-0.16px',
                   }}
                 >
                                       <p>
                      <span style={{ fontWeight: 500, color: '#1c2024', fontSize: '16px' }}>Issued: </span>
                      <span style={{ fontWeight: 400, color: '#80838d', fontSize: '16px' }}>{cveData.issued}</span>
                    </p>
                 </div>
                
                <p 
                  style={{
                    alignSelf: 'stretch',
                    color: '#80838d',
                    fontFamily: 'HarmonyOS Sans SC',
                    fontSize: '16px',
                    fontStyle: 'normal',
                    fontWeight: 400,
                    lineHeight: 'normal',
                    letterSpacing: '-0.16px',
                    marginTop: '4px',
                  }}
                >
                  This container includes required additional information provided by the CVE Program for this vulnerability.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  )
}

CVEInfoPage.getProviders = (page: any, pageProps: any) => {
  return (
    <AuthAppProviders {...pageProps}>
      <AppLayout {...pageProps}>{page}</AppLayout>
    </AuthAppProviders>
  )
}
